# Discards

*Last modified: `r as.Date(file.info(here::here("Documentation", "10-discards.Rmd"))$mtime)`*

Information on discarded catch from fishing effort in the Greater Atlantic comes from 3 main sources (in decreasing order of availability):

1) Vessel trip reports (VTRs)
2) Human at-sea observers
3) Electronic monitoring (EM) systems

Despite reporting requirements that should make discarded catch available for any trip with a VTR, concerns with accuracy prevent these records from contributing to discard estimation in most circumstances.  Additionally, some fisheries do not require VTR submission.

The *majority* of discarded catch for most species and fishing effort is estimated following the Standardized Bycatch Reporting Methodology (SBRM) originally described by Wigley et al. (2007).  The process involves using a ratio estimator (Cochran 1977) for trips carrying a human at-sea observer (i.e., "observed" trips) to estimate the rate (or ratio) of discarded catch for a given species per pound of total kept catch (i.e., a proxy for effort).  Unobserved trips are assumed to discard a given species at similar rates to observed trips depending on a collection of stratification variables describing vessel attributes (e.g., gear type and mesh) and potentially other relevant attributes regarding location and time of year.  In-season estimation includes additional methods to accommodate sparse data in the early part of a fishing season for species with quota management needs (GARFO 2016).

Here, we outline the approaches being used in CAMS to estimate discards, and document some business rules for determining how an "official" estimate of discarded catch is determined for a given species and unit of fishing effort.  The latter is particularly important for trips that have multiple sources of information on discarded catch and are subject to management rules in one or more fisheries.

### Species of interest defined

A list of species including those that are currently quota monitored, and others identified in the national bycatch report, is needed to define the range of discard estimates required for the region.  The species of interest are restricted to fish/invertebrates (including scallops/clams), as other taxa (marine mammals, sea turtles, sea birds) involve a variety of analyses for estimating bycatch that have been determined to be outside the scope of CAMS.  Rare fish species that vary in presence across time may be included or excluded depending on needs.

Table 1 (*see* [Requirements Tables](https://docs.google.com/spreadsheets/d/1FnNIwFJSBXT2X7uN9tVCbQOwEO7RLfcg6lkfs7R4SA8/edit?usp=sharing)) contains a list of approximately 310 species that will be included in CAMS, by common name, scientific name, and composition (individual or species group).  Species associated with quota monitoring and stock assessments are identified.

### Stratification or “fleets” for discard sampling/estimation defined

Proper sampling and estimation of discards requires a table of stratification variables for each species, including area definitions (for stocks or management units), gear, mesh, and other relevant attributes (e.g., regulatory groups).  Some of the attributes will be species specific while others will apply similarly to all species.  For many species that are quota monitored, stratification schemes are defined by regulations from a Fishery Management Plan (FMP) and have agreed upon attributes.  Other species may have more flexible stratification approaches, though most will simply take the stratification used by SBRM.

A species-centric stratification means that any given trip will fall into one or more “fleets” depending on the attributes of the trip (e.g., gear or FMP) and the species discards being estimated. For example, a “groundfish” trip will have estimates of discards for groundfish species that involve sector-specific discard rates, such that the sector identification helps to define the fleet in which that given trip is a member for those particular species.  Other non-groundfish species will have discard estimates generated by rates that are not sector specific.  An important business rule is that any given trip (sub-trip) can only belong to one fleet (i.e., stratum) for a given species and fleets are non-overlapping.

Stratification variables are largely derived from information on VTRs, including the gear, mesh, and statistical area fished.  Other regulatory information may come from Allocation Management System (AMS) declarations, permit information, or other sources existing or emerging that need to be defined and reliably available for the relevant trips which require further stratification. For example, vessels participating in the sea scallop FMP will declare their intention to harvest with either a limited access or a general category permit, a dichotomy that is used in discard rate stratification.

An important requirement for stratification is the reconciliation of categories or groups within a stratification attribute between GARFO and NEFSC.  The present definitions of an attribute (Table 2; *see* [Requirements Table](https://docs.google.com/spreadsheets/d/1FnNIwFJSBXT2X7uN9tVCbQOwEO7RLfcg6lkfs7R4SA8/edit#gid=2014412167)) may have more or fewer categories depending on the objective (quota monitoring or stock assessments).  Spatial and temporal stratifications require particular attention.  Some species are managed as multiple stocks while others have unit stocks but with multiple regions for discard estimation.  In-season quota monitoring will require temporal parameters that match a given FMP, while SBRM and stock assessments use time periods that straddle multiple fishing years.  Currently, there are 4 distinct 12 month periods associated with the 14 FMPs; stock assessments use a calendar year and SBRM analyses use a “blended year”. 

#### Area strata

Stratification by statistical areas follows stock definitions for many species. Some species have within stock stratification (e.g., Atlantic cod) or a north/south split for unit stocks (e.g., black sea bass).  These definitions are stored in a support table (`APSD.CAMS_STATAREA_STOCK`) that lists the relevant area stratification for each managed species and statistical area in the Greater Atlantic region.


#### Gear/mesh strata

Gear type is a primary stratification attribute and different species have different groupings of gear types into gear strata, sometimes with area-specific discard mortality rates. 

We start with VTR-defined gear types (e.g., OTF = "otter trawl, bottom, fish") which have previously been mapped to NEGEAR types in a support table (`FVTR.FVTR_GEAR_CODES`).  To accommodate many-to-many relationships that are largely due to undefined or "other" categories of gear, we developed a master gear list for CAMS (see [VTR_NEGEAR](https://docs.google.com/spreadsheets/d/1-3NNEqf22CTcnkQEiUeNHsrPJuTq5n6b/edit#gid=956771801)) with an indicator for valid CAMS pairings of VTR-NEGEAR relationships.  This allows each VTR gear code to map to a single NEGEAR type, with NEGEAR type groupings defined by stock assessment needs (see [GEAR_STRATA_MORT](https://docs.google.com/spreadsheets/d/1-3NNEqf22CTcnkQEiUeNHsrPJuTq5n6b/edit#gid=997072514)).  A final support table of species-gear-area stratification (`CAMS_DISCARD_MORTALITY_STOCK`) was created as a comprehensive source of discard mortalities.

Mesh applies to certain gear types, and may require species-specific categorization (see [GEAR_STRATA_MORT](https://docs.google.com/spreadsheets/d/1-3NNEqf22CTcnkQEiUeNHsrPJuTq5n6b/edit#gid=997072514)).  Thus far, no support tables have been built to accommodate mesh.

#### Regulatory and other strata

The SBRM stratification (see [SBRM](https://docs.google.com/spreadsheets/d/1-3NNEqf22CTcnkQEiUeNHsrPJuTq5n6b/edit#gid=1223582378)) includes regulatory attributes such as access area and trip category distinctions for scallop effort, while quota monitoring requires a sector distinction for groundfish trips.  This information is supplied by a support table (e.g., `CAMS trip attr` or something similar) that contains all relevant regulatory information for a given trip, including active permits and trip declarations.

## Trip-level discard estimates

Each trip (sub-trip) will have one or more estimates of dead discards depending on the species of interest and the monitoring program in which the vessel participated.  All trips can receive a ratio estimate based on the quantity of kept catch on the trip and the estimated discard rate and discard mortality rate for the relevant stratum.  The estimate that is used for a given objective may be context dependent, though catch accounting requires a single estimate to serve as an official record.  In most circumstances, direct observations of species discards by qualified observers will take precedent.

### Direct observations

Trips that carry a human at-sea observer or have EM video that has been reviewed can provide official records of observed discards.  These observations comprise separate data streams that require integration in CAMS, including matching to effort/landings records (e.g., VTRs) so that stratification attributes can be identified.  Some monitoring programs (e.g., groundfish EM2) operate under the premise that vessel crew members can estimate discards for certain species; these records appear in the VTR and are not a separate data stream.

#### Prorated discards

Some trips will have direct observations that are incomplete due to missed or unobserved hauls.  For these trips, the total discards for a species must be prorated from those hauls that were observed.  This is done by applying a ratio of kept catch on the entire trip to kept catch on the unobserved hauls only:

$$d_{spp,i} = \left(\sum_{h\in obs_{h}=\text{T}}d_{spp,i,h}\right)\left(1+\frac{\sum_{h\in obs_{h}=\text{F}}k_{i,h}}{\sum{k}_{i,h}}\right)$$

Here, the estimated discards ($d$) for a species ($spp$) on trip $i$ equates to the recorded discards on hauls ($h$) that were observed ($obs_{h}=\text{T}$) multiplied by the ratio of kept catch ($k$) for unobserved hauls ($obs_{h}=\text{F}$) to the total kept catch across all hauls for the trip.


#### EM discards

The EM monitoring programs will provide direct observations for some species.  The species-centric approach will mean that discard estimation of EM trips will be handled differently depending on the species of interest.  For example, direct observations of Atlantic cod may be available for EM groundfish trips that have been reviewed but other non-groundfish species will require ratio estimation.

The design and implementation of EM programs may initially be outside the scope of CAMS but require integration for complete catch accounting.

### Ratio estimation

The `discaRd` R package was designed for quota monitoring (GARFO 2016) and implements the "separate" ratio estimator (Cochran 1977), consistent with approaches used by SBRM (Wigley et al. 2007).  As such, observed trips are used to estimate the rate of species discarding per unit effort, with effort approximated by the total kept catch (i.e., pounds).  Given that the discards ($d$) and total kept catch ($k$) are both measured in pounds, technically $d/k$ is a ratio.  We use ratio and rate interchangeably here, recognizing that units of effort could be (and have been) measured in other ways (e.g., days at sea).

Here, the ratio or rate of species discards to total kept catch within stratum $j$ is defined as:

$$ r_{spp,j} = \frac{\sum_i^{n_j} d_{spp,i,j}}{\sum_i^{n_j} k_{i,j}} $$
with total pounds of discard:

$$ \hat{D}_{spp} = \sum_{j=1}^{J}{K_j r_{spp,j}} $$

and with analytic variance calculated as:

$$ V(\hat{D}_{spp}) = \sum_{j=1}^{J} \left(\frac{N_j-n_j}{n_j N_j}\right) \frac{1}{\left(\frac{\sum_{i}^{n_j}k_{i,j}}{n_j} \right)^2} 
\left[\frac{\sum_{i}^{n_j}(d_{spp,i,j}^2+r_{spp,j}^2 k_{i,j}^2 - 2r_{spp,j}d_{spp,i,j}k_{i,j})}{n_j - 1}\right]
$$

Finally, the preceding terms are defined as follows:

- $r_{spp,j}$ is the separate ratio for species $spp$ in stratum $j$
- $d_{spp,i,j}$ is discards of species $spp$ from observed trip $i$ in stratum $j$;
- $k_{i,j}$ is the kept pounds of all species on observed trip $i$
- $n_j$ is the number of observed trips in stratum $j$
- $N_j$ is the number of total trips in stratum $j$
- $J$ is the number of strata
- $\hat{D}_{spp}$ is the total estimated discarded pounds for species $spp$
- $K_j$ is the total kept pounds of all species in stratum $j$

Note, the analytic variance contains a finite population correction, recognizing that most strata will have sampling rates over 10%.

Stratum-specific estimates of the total discards, $\hat{D}_{spp,j}$, and associated variance, $V(\hat{D}_{spp,j})$, can be calculated as needed.  Additionally, the variance or error associated with trip-level predictions can also be derived.

#### Transition of discard rates between seasons

In-season monitoring of the cumulative discard for a given species and fishery requires the application of a discard rate to all completed trips up to the day of calculation. During the early part of the fishing season, or for low-effort strata, the sample size of observed trips may be too small for a stable and reasonable estimate of the discard rate. To improve in-season estimates of discard, information from the previous fishing year is used in varying degrees as an adjustment.

As such, we calculate a weighted mean between the estimated discard rate of the previous year and that for the current year when the number of observed trips, $n_j$, is >0 and <5. The weighted mean is calculated as follows:

$$r_{spp,j}^* = \left(\frac{0.7}{n_j}\right)r_{spp,j}^{t-1} + \left(1-\frac{0.7}{n_j}\right)r_{spp,j}^{t}$$
Here, $r_{spp,j}^*$ is the transition discard rate, $r_{spp,j}^{t-1}$ is the "assumed" discard rate from the previous year ($t-1$), and $r_{spp,j}^{t}$ is the in-season rate from the current year ($t$).


### discaRd Base and Support tables

```{r d_table_flow0, echo = F, fig.height = 8, fig.width = 8, fig.cap = "Base tables (rectangle), Intermediary (circle), and Support tables (Oval)", warning = F, eval = F}
library(DiagrammeR)

grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = false, fontsize = 32, fillcolor = red]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica
        , fontsize = 32
        fontcolor = 'darkgreen', 
        penwidth = 2]
  'DLR_VTR'; 
  
  'STG_TRIP_ATTR';
  
  'NEFOP';
  
  'ASM';

 node [shape = oval,
        fontname = Helvetica
        , fillcolor = 'Cyan']
  'CAMS
  STATAREA
  STOCK'; 
  
  'CAMS
  GEARCODE
  STRATA'; 
  
  'CAMS
  DISCARD
  MORTALITY
  STOCK';

  node [shape = circle,
        fixedsize = false,
        width = 2,  fontsize = 32] // sets as circles
   ; 
  
  'OBS 
   by YEAR' ; 
   
   'CAMS_CATCH'; 
   
   'CAMS_OBS_PRORATE';
  
  node [shape = diamond,
        fixedsize = false,
        width = 2,  fontsize = 40, fontweight = 'bold'] // 
  'R';
  

  # several 'edge' statements

  'NEFOP'->'OBS 
   by YEAR'

  'ASM'->'OBS 
   by YEAR'

  'OBS 
   by YEAR'->'CAMS_OBS_PRORATE'
  
  'DLR_VTR' -> 'CAMS_CATCH'

  'STG_TRIP_ATTR' ->'CAMS_CATCH'
  
  'CAMS_CATCH'->  'CAMS_OBS_CATCH'
  
'CAMS_OBS_PRORATE'->  'CAMS_OBS_CATCH'
  
  'CAMS_OBS_CATCH'->'R'
  
  'CAMS
  STATAREA
  STOCK'-> 'R'
  
  'CAMS
  GEARCODE
  STRATA'->'R'
  
  'CAMS
  DISCARD
  MORTALITY
  STOCK'->'R'
  
 
}
")

```



 [Base table flowchart link](https://docs.google.com/presentation/d/1UvRxc5G50A7_2Fb6vBObi1SJYR9EjZJb/edit#slide=id.p9)
 
 Observer base tables are constructed for each calendar year for all species. Detials can be found here: [CAMS_OBDBS_<YYYY> table summary](document_OBS_CAMS.html)
 
 
 Matching observer data to CAMS subtrip is a key element of the CAMS discard estimation process. Description of the proces scan be found in the [CAMS_OBS_CATCH table summary](document_CAMS_OBS_CATCH.html)
 
 and here: [CAMS_OBS_CATCH flowchart](https://docs.google.com/presentation/d/1UvRxc5G50A7_2Fb6vBObi1SJYR9EjZJb/edit#slide=id.g12cc93386e8_0_20)

(add support table links/descriptions..)

 
## Steps for running discard estimation

- refresh/build Oracle tables (SQL)
	+ `CAMS_OBDBS_<YYYY>`
	+ `CAMS_OBS_CATCH`
- import two or more years of`CAMS_OBS_CATCH` to R depending on the run needed. A minimum of two calendar years is neccesary.
- **For each module, a group of species is defined**
	+ apply `CAMS_GEAR_GROUP` according to SPECIES
	+ apply `STOCK STAT AREA` according to SPECIES and stock (if needed)
  + join discard mortality by species/stock/CAMS_GEAR_GROUP using `CAMS_DISCARD_MORTALITY`
	+ `STRATA` is assigned dynamically using elements of the imported data. This is mostly standardized except for groundfish trips, which have extra stratification variables
	+  Two time periods are defined according to focal and previous fishing year, by species. This allows a `transition rate` calculation
	+ Assumed rates (e.g. sector rollup, gear/mesh, gear only, broad stock) are defined as a subset of STRATA
- Estimation is done using the `discaRd` R package built for 2016 Discard Estimation Peer Review. `run_discard` function is applied for each time period and species. Two or three passes of this routine are done, each using a less coarse stratification, depending on module specifics. 
- Assign `CAMS_DISCARD_RATE` through business rules for the trip (e.g., observed trips receive the observed value, EM rules)
	+ note the `DISCARD_SOURCE`
- Apply `CAMS_DISCARD_RATE` to kept all for the trip. This is the estimated discard. 
- Apply discard mortality to discard to get finalized discard estimate.


## Discard Source

There are several possible sources of discard based on type of trip and stratification used for that trip. 

Groundfish estimates from groundfish trips are as follows:

 - (I) in season rate; >= 5 trips in Full Stratification
 - (T) Transition in season rate; < 5 trips in Full Stratification, year t, AND >= 5 trips in year t-1
 - (A) Assumed rate. This is the *second pass* rate that rolls up all Sectors. Common Pool trips are separated in this strata.
 - (B) Broad stock rate is used when other criteria are not met. 
 - (E) Electronic monitoring (EM) video based estimate. If the trip is reviewed and passed; and there was no human observer on board. 
 - (V) VTR (self-reported) discard estimate on an EM trip that was reviewed and failed; and there was no human observer on board. 
 - (D) Delta model estimate of VTR discard on an EM trip that was reviewed and failed; and there was no human observer on board. 
 - (O) Observed values used from observed trips; discard rate is NOT USED. 
 
Non-Groundfish trips are as follows:

 - (I) in season rate; >= 5 trips in Full Stratification
 - (T) Transition in season rate; < 5 trips in Full Stratification, year t, AND >= 5 trips in year t-1
 - (GM) Assignment is from the second pass (e.g. Stock/Gear/Meshgroup). This is the rate when there were <5 trips in season and <5 in previous season at the full stratification level.
 - (G) Assignment is from the *second pass* (e.g. Stock/Gear). 
 - (N) No coverage in focal season and previous season; discard rate is not possible to estimate.
 - (O) Observed values used from observed rate trips; discard rate is NOT USED. 
 
 [Discard source flowchart link](https://docs.google.com/presentation/d/1UvRxc5G50A7_2Fb6vBObi1SJYR9EjZJb/edit#slide=id.g1318c2be061_1_5)


**More detailed descriptions are found in the summary pages for the individual modules.** (link??)

## Discard Modules in CAMS

Modules based on GARFO Quota Monitoring (<span style="color:orange"> species where in-season estimation is required</span>) :

  - May Fishing Year
    - <span style="color:orange">Groundfish </span>
    - Monkfish
    - Dogfish
    - Skates 
    - Hakes
    - <span style="color:orange">Haddock Catch cap (herring Trips) </span>
  - April Fishing year
    - Scallops  
    - <span style="color:orange">Flatfish bycatch</span>
  - January Fishing Year (Calendar Year): 
    - Squid/Mack/<span style="color:orange"> Butterfish </span>
    - Herring
    - <span style="color:orange">River Herring/Shad Catch Cap  </span>
    - Bluefish
    - Summer flounder
    - Black Sea Bass
    - Scup
  - November Fishing Year
    - Tilefish  

```{r}

```


#### Future design

If all strata were observed then the sampling would achieve a full factorial design, whereby all combinations of stratum attributes have an associated discard rate estimate.  Some strata will inevitably have no observed trips ($n_j = 0$) in a given fishing season, and even across multiple seasons, for combinations of stratification attributes that result in rare (but non-zero: $N_j>0$) effort.  The choice of a discard rate for an unobserved stratum has historically been somewhat arbitrary and required manual selection of a "similar" stratum to inform the discard estimate.

One proposed strategy is to take a model-based approach to discard estimation and estimate the additive effects of stratification attributes instead of the multiplicative interactions.  This reduces the sampling needed and provides a pragmatic replacement estimate for unobserved strata.

It can be shown that a Poisson regression of discards with log-scale kept catch as an offset can approximate the ratio estimator as follows:

$$ d_{spp,i} \sim Poisson(\lambda_{spp,i} k_i)$$
$$ \text{log}(\lambda_{spp,i}) = \mathbf{X}_{i} \boldsymbol{\beta}_{spp}$$

where $\lambda_{spp,i}$ is the estimated species discard rate per pound of kept catch, $\mathbf{X}_{i}$ is a design matrix of additive effects for relevant stratification attributes on trip $i$, and $\boldsymbol{\beta}_{spp}$ are species-specific coefficients for the additive effects.

As an example, if stratification involved 3 gear types ("A", "B", "C") and 2 areas ("North" and "South"), the ratio estimation would typically estimate rates for 2 x 3 = 6 different strata.  The equivalent Poisson model above would require 6 coefficients $(\beta_{AN}, \beta_{BN}, \beta_{CN}, \beta_{AS}, \beta_{BS}, \beta_{CS})$, one for each stratum.  If the design matrix specified addictive effects instead of the full factorial interactions, only 4 coefficients would be required $(\beta_{0}, \beta_{B}, \beta_{C}, \beta_{S})$.  Crucially, if no trips were observed for gear = C in area = South, the full factorial model could not be estimated.  The missing observations are not a problem for the additive model, and predictions could still be generated for unobserved trips with those attributes based on the overall effects: $\text{E}(\text{log}(\lambda)) = \beta_0 + \beta_C + \beta_S$.

To implement the proposed approach, an unsampled stratum needs to be identified and have estimates of $\text{E}(\lambda_{spp,j})$ replace $r_{spp,j}$ as described to estimate $\hat{D}_{spp,j}$, the total species discards for the given stratum.
